<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Calculadora de Ox√≠geno (con TimePicker)</title>
<style>
  :root{--bg:#f8fafc;--card:#fff;--muted:#94a3b8;--accent:#0ea5a0;--danger:#d32f2f}
  body{font-family:Inter,Segoe UI,system-ui,Arial; margin:0; background:var(--bg); color:#0f172a}
  header{background:linear-gradient(90deg,#0ea5a0,#06b6d4); color:#fff; padding:18px 16px}
  .container{max-width:1100px;margin:20px auto;padding:16px}
  .title{display:flex;align-items:center;gap:12px}
  .title h1{margin:0;font-size:20px}
  .subtitle{opacity:.9;margin-top:6px;font-size:13px}
  .card{background:var(--card);border-radius:10px;padding:12px;box-shadow:0 6px 18px rgba(2,6,23,.06);margin-top:16px}
  .insurance{display:flex;gap:8px;margin-top:8px}
  .btn{padding:8px 12px;border-radius:8px;border:1px solid transparent;cursor:pointer;display:inline-flex;gap:8px;align-items:center}
  .btn--muted{background:#f1f5f9;color:#0f172a;border-color:transparent}
  .btn--active{background:#064e3b;color:#fff;border-color:rgba(255,255,255,.06)}
  .table-scroll{overflow:auto;margin-top:12px}
  table{border-collapse:collapse;width:100%;min-width:820px}
  th,td{padding:8px 10px;text-align:left;border-bottom:1px solid #eef2f6;font-size:14px}
  th{background:#f8fafc;color:#334155}
  .num{width:36px;text-align:center}
  .time-cell{width:120px; text-align:center; cursor:pointer; color:var(--muted)}
  input[type="text"], input[type="number"]{width:100%;padding:6px;border-radius:6px;border:1px solid #e6eef6;background:#fafbfd}
  .small{width:80px;text-align:center}
  .actions{display:flex;gap:8px;align-items:center}
  .add-btn{background:#0ea5a0;color:#fff;padding:8px 10px;border-radius:8px;cursor:pointer;border:none}
  .delete-btn{background:transparent;border:none;color:var(--danger);cursor:pointer}
  .total{display:flex;align-items:center;justify-content:space-between;margin-top:12px}
  .share-btn{background:#128c7e;color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
  .muted{color:var(--muted);font-size:13px}
  @media (max-width:720px){
    .title h1{font-size:16px}
    table{min-width:700px}
  }

  /* TimePicker modal styles */
  .tp-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:9999}
  .tp-backdrop.show{display:flex}
  .tp-modal{background:#fff;border-radius:12px;padding:18px;width:92%;max-width:460px;box-shadow:0 10px 30px rgba(2,6,23,.2)}
  .tp-title{text-align:center;font-weight:700;color:#0f172a;margin-bottom:12px}
  .tp-pickers{display:flex;gap:8px;justify-content:space-between;margin-bottom:12px}
  .tp-column{flex:1;max-width:33%}
  .tp-label{font-size:12px;color:#64748B;text-align:center;margin-bottom:8px;font-weight:600}
  .tp-scroll{max-height:160px;overflow:auto;border-radius:8px;padding:6px;background:#fafbfd}
  .tp-option{padding:8px;border-radius:8px;margin:4px 0;text-align:center;cursor:pointer}
  .tp-option.active{background:#7c4dff;color:#fff;font-weight:700}
  .tp-ampm{display:flex;flex-direction:column;gap:6px;align-items:center}
  .tp-preview{background:#F5F6FA;border-radius:10px;padding:12px;text-align:center;margin-bottom:12px}
  .tp-buttons{display:flex;gap:10px}
  .tp-btn{flex:1;padding:10px;border-radius:8px;cursor:pointer;border:none}
  .tp-btn.cancel{background:#E2E8F0;color:#64748B}
  .tp-btn.confirm{background:#9575CD;color:#fff}
  .tp-time-display{font-size:20px;font-weight:700;color:#7c4dff}
</style>
</head>
<body>
<header>
  <div style="max-width:1100px;margin:0 auto">
    <div class="title">
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none"><path d="M3 13h4v8H3zM9 3h4v18H9zM15 7h4v14h-4z" fill="#fff"/></svg>
      <div>
        <h1>Calculadora de Ox√≠geno</h1>
        <div class="subtitle">C√°lculo de costo por suministro</div>
      </div>
    </div>
  </div>
</header>

<div class="container">
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <strong>Tipo de Seguro</strong>
        <div class="insurance" id="insuranceButtons">
          <button class="btn btn--active" data-type="contributivo" id="btnContri">
            Contributivo <span style="margin-left:8px;opacity:.9">Factor 0.45</span>
          </button>
          <button class="btn btn--muted" data-type="subsidiado" id="btnSubs">
            Subsidiado <span style="margin-left:8px;opacity:.9">Factor 0.25</span>
          </button>
        </div>
      </div>
      <div style="text-align:right">
        <div class="muted">Factor aplicado: <span id="factorLabel">0.45 (contributivo)</span></div>
        <button class="add-btn" id="addRowBtn" title="Agregar fila">‚ûï Agregar</button>
      </div>
    </div>

    <div class="table-scroll">
      <table id="entriesTable" aria-live="polite">
        <thead>
          <tr>
            <th class="num">#</th>
            <th style="width:110px">Inicio</th>
            <th style="width:110px">Fin</th>
            <th style="width:80px">L/min</th>
            <th style="width:80px">Min</th>
            <th style="width:100px">Costo</th>
            <th style="width:40px"></th>
          </tr>
        </thead>
        <tbody id="tbodyEntries"></tbody>
      </table>
    </div>

    <div class="total">
      <div>
        <div class="muted">Total a Pagar</div>
        <div style="font-size:20px;font-weight:600">$<span id="totalAmount">0.00</span></div>
      </div>
      <div style="text-align:right">
        <button class="share-btn" id="shareBtn">Compartir por WhatsApp</button>
        <div class="muted" style="margin-top:6px">Formato de hora visual: 12h (AM/PM)</div>
      </div>
    </div>
  </div>
</div>

<!-- TimePicker modal -->
<div id="tpBackdrop" class="tp-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="tp-modal" role="document" aria-labelledby="tpTitle">
    <div id="tpTitle" class="tp-title">Seleccionar Hora</div>
    <div class="tp-pickers">
      <div class="tp-column">
        <div class="tp-label">Hora</div>
        <div id="tpHours" class="tp-scroll"></div>
      </div>
      <div class="tp-column">
        <div class="tp-label">Minuto</div>
        <div id="tpMinutes" class="tp-scroll"></div>
      </div>
      <div class="tp-column">
        <div class="tp-label">AM / PM</div>
        <div class="tp-ampm">
          <button id="tpAM" class="tp-option">AM</button>
          <button id="tpPM" class="tp-option">PM</button>
        </div>
      </div>
    </div>

    <div class="tp-preview">
      <div class="tp-time-display" id="tpPreviewTime">12:00 AM</div>
    </div>

    <div style="display:flex;gap:10px">
      <button class="tp-btn cancel" id="tpCancel">Cancelar</button>
      <button class="tp-btn confirm" id="tpConfirm">Confirmar</button>
    </div>
  </div>
</div>

<script>
(function(){

  /* ---------- Config y estado ---------- */
  const INITIAL_ROWS = 20;
  let insuranceType = 'contributivo';
  let paymentFactor = 0.45;

  // Estado de entradas: guardamos startTime/endTime en "HH:MM" (24h) strings
  let entries = Array.from({length: INITIAL_ROWS}, (_,i)=>({
    id: 'entry-' + i,
    startTime: '',
    endTime: '',
    flowRate: ''
  }));

  // TimePicker state
  let tpVisible = false;
  let tpCurrent = null; // { entryId, field }
  let tpHour = 12;
  let tpMinute = 0;
  let tpAmpm = 'AM';

  /* ---------- Helpers de tiempo ---------- */
  function pad(n){ return String(n).padStart(2,'0'); }

  function parseTimeToMinutes(timeStr){
    if(!timeStr) return null;
    const s = String(timeStr).trim().toUpperCase();
    // Match "H:MM AM/PM" or "HH:MM"
    const m = s.match(/^(\d{1,2}):(\d{2})(?:\s*(AM|PM))?$/i);
    if(!m) return null;
    let hours = parseInt(m[1],10);
    const minutes = parseInt(m[2],10);
    const ampm = m[3];
    if(isNaN(hours) || isNaN(minutes)) return null;
    if(ampm){
      if(ampm === 'PM' && hours < 12) hours += 12;
      if(ampm === 'AM' && hours === 12) hours = 0;
    }
    if(hours < 0 || hours > 23 || minutes < 0 || minutes > 59) return null;
    return hours * 60 + minutes;
  }

  function minutesDiff(startStr, endStr){
    const s = parseTimeToMinutes(startStr);
    const e = parseTimeToMinutes(endStr);
    if(s === null || e === null) return 0;
    let diff = e - s;
    if(diff < 0) diff += 24*60;
    return diff;
  }

  function formatToDisplay(timeStr){
    if(!timeStr) return '';
    // timeStr expected "HH:MM"
    const m = String(timeStr).trim().match(/^(\d{1,2}):(\d{2})$/);
    if(!m) return timeStr;
    let h = parseInt(m[1],10);
    const mins = m[2];
    const ampm = h >= 12 ? 'PM' : 'AM';
    let h12 = h % 12;
    if(h12 === 0) h12 = 12;
    return h12 + ':' + mins + ' ' + ampm;
  }

  function formatTimeValueForInput(timeStr){
    if(!timeStr) return '';
    const ampmMatch = timeStr.toString().match(/(AM|PM)$/i);
    if(ampmMatch){
      const part = timeStr.replace(/\s*(AM|PM)$/i,'').trim();
      const p = part.split(':');
      let h = parseInt(p[0],10);
      const mins = (p[1] || '00').padStart(2,'0');
      const ap = ampmMatch[1].toUpperCase();
      if(ap === 'PM' && h < 12) h += 12;
      if(ap === 'AM' && h === 12) h = 0;
      return String(h).padStart(2,'0') + ':' + mins;
    }
    // assume HH:MM
    const parts = timeStr.split(':');
    if(parts.length >= 2){
      const h = String(parts[0]).padStart(2,'0');
      const m = String(parts[1]).slice(0,2).padStart(2,'0');
      return h + ':' + m;
    }
    return '';
  }

  function hhmmToParts(hhmm){
    // returns {hour12, minute, ampm}
    if(!hhmm) return {hour12:12, minute:0, ampm:'AM'};
    const m = hhmm.match(/^(\d{1,2}):(\d{2})$/);
    if(!m) return {hour12:12, minute:0, ampm:'AM'};
    let h = parseInt(m[1],10);
    const minute = parseInt(m[2],10);
    const ampm = h >= 12 ? 'PM' : 'AM';
    let h12 = h % 12;
    if(h12 === 0) h12 = 12;
    return { hour12: h12, minute, ampm };
  }

  function partsToHHMM(hour12, minute, ampm){
    let h = hour12;
    if(ampm === 'PM' && h < 12) h += 12;
    if(ampm === 'AM' && h === 12) h = 0;
    return pad(h) + ':' + pad(minute);
  }

  /* ---------- DOM refs ---------- */
  const tbody = document.getElementById('tbodyEntries');
  const totalAmountEl = document.getElementById('totalAmount');
  const factorLabel = document.getElementById('factorLabel');
  const tpBackdrop = document.getElementById('tpBackdrop');
  const tpHoursEl = document.getElementById('tpHours');
  const tpMinutesEl = document.getElementById('tpMinutes');
  const tpAMBtn = document.getElementById('tpAM');
  const tpPMBtn = document.getElementById('tpPM');
  const tpPreviewTime = document.getElementById('tpPreviewTime');
  const tpCancel = document.getElementById('tpCancel');
  const tpConfirm = document.getElementById('tpConfirm');

  /* ---------- Renderers ---------- */
  function render(){
    tbody.innerHTML = '';
    entries.forEach((entry, idx) => {
      const tr = document.createElement('tr');

      const tdNum = document.createElement('td'); tdNum.className='num'; tdNum.textContent = (idx+1);
      tr.appendChild(tdNum);

      const tdStart = document.createElement('td');
      tdStart.className = 'time-cell';
      tdStart.title = "Click para seleccionar hora";
      tdStart.dataset.entryId = entry.id;
      tdStart.dataset.field = 'startTime';
      tdStart.textContent = entry.startTime ? formatToDisplay(formatTimeValueForInput(entry.startTime)) : 'HH:MM';
      tr.appendChild(tdStart);

      const tdEnd = document.createElement('td');
      tdEnd.className = 'time-cell';
      tdEnd.dataset.entryId = entry.id;
      tdEnd.dataset.field = 'endTime';
      tdEnd.title = "Click para seleccionar hora";
      tdEnd.textContent = entry.endTime ? formatToDisplay(formatTimeValueForInput(entry.endTime)) : 'HH:MM';
      tr.appendChild(tdEnd);

      const tdFlow = document.createElement('td');
      tdFlow.className = 'small';
      const flowInput = document.createElement('input');
      flowInput.type = 'number';
      flowInput.step = '0.1';
      flowInput.min = '0';
      flowInput.value = entry.flowRate;
      flowInput.placeholder = '0.0';
      flowInput.addEventListener('input', (ev)=> {
        updateEntry(entry.id, 'flowRate', ev.target.value);
      });
      tdFlow.appendChild(flowInput);
      tr.appendChild(tdFlow);

      const tdMin = document.createElement('td');
      tdMin.className = 'small';
      const mins = minutesDiff(entry.startTime, entry.endTime);
      tdMin.textContent = mins > 0 ? String(mins) : '-';
      tr.appendChild(tdMin);

      const tdCost = document.createElement('td');
      tdCost.className = 'small';
      const cost = calculateCostForEntry(entry);
      tdCost.textContent = cost > 0 ? cost.toFixed(2) : '-';
      tr.appendChild(tdCost);

      const tdDel = document.createElement('td');
      tdDel.style.textAlign = 'center';
      const delBtn = document.createElement('button');
      delBtn.className = 'delete-btn';
      delBtn.innerHTML = 'üóëÔ∏è';
      delBtn.title = 'Eliminar';
      delBtn.addEventListener('click', ()=> removeEntry(entry.id));
      tdDel.appendChild(delBtn);
      tr.appendChild(tdDel);

      tbody.appendChild(tr);

      tdStart.addEventListener('click', ()=> openTimePicker(entry.id, 'startTime', entry.startTime));
      tdEnd.addEventListener('click', ()=> openTimePicker(entry.id, 'endTime', entry.endTime));
    });

    totalAmountEl.textContent = calculateTotal().toFixed(2);
    factorLabel.textContent = paymentFactor + ' (' + insuranceType + ')';
  }

  /* ---------- L√≥gica de CRUD ---------- */
  function updateEntry(id, field, value){
    entries = entries.map((e) => e.id === id ? {...e, [field]: value} : e);
    if(field === 'endTime'){
      const idx = entries.findIndex(e => e.id === id);
      if(idx !== -1 && idx + 1 < entries.length){
        const next = entries[idx+1];
        if(!next.startTime){
          entries[idx+1] = {...next, startTime: value};
        }
      }
    }
    render();
  }

  function removeEntry(id){
    if(entries.length <= 1) return;
    entries = entries.filter(e => e.id !== id);
    render();
  }

  function addEntry(){
    const newEntry = { id: 'entry-' + Date.now(), startTime:'', endTime:'', flowRate:''};
    entries.push(newEntry);
    render();
    window.requestAnimationFrame(()=> {
      const last = tbody.lastElementChild;
      if(last) last.scrollIntoView({behavior:'smooth', block:'end'});
    });
  }

  /* ---------- C√°lculos ---------- */
  function calculateCostForEntry(entry){
    const mins = minutesDiff(entry.startTime, entry.endTime);
    const flow = parseFloat(entry.flowRate) || 0;
    return mins * flow * paymentFactor;
  }

  function calculateTotal(){
    return entries.reduce((sum, e) => sum + calculateCostForEntry(e), 0);
  }

  /* ---------- TimePicker UI logic ---------- */
  // Construir horas/minutos
  function buildTpOptions(){
    tpHoursEl.innerHTML = '';
    for(let h=1; h<=12; h++){
      const btn = document.createElement('div');
      btn.className = 'tp-option';
      btn.textContent = String(h).padStart(2,'0');
      btn.dataset.hour = String(h);
      btn.addEventListener('click', ()=> {
        tpHour = parseInt(btn.dataset.hour,10);
        syncTpSelection();
      });
      tpHoursEl.appendChild(btn);
    }

    tpMinutesEl.innerHTML = '';
    for(let m=0; m<60; m++){
      const btn = document.createElement('div');
      btn.className = 'tp-option';
      btn.textContent = String(m).padStart(2,'0');
      btn.dataset.minute = String(m);
      btn.addEventListener('click', ()=> {
        tpMinute = parseInt(btn.dataset.minute,10);
        syncTpSelection();
      });
      tpMinutesEl.appendChild(btn);
    }

    tpAMBtn.addEventListener('click', ()=> { tpAmpm = 'AM'; syncTpSelection(); });
    tpPMBtn.addEventListener('click', ()=> { tpAmpm = 'PM'; syncTpSelection(); });

    tpCancel.addEventListener('click', closeTimePicker);
    tpConfirm.addEventListener('click', confirmTimePicker);
  }

  function openTimePicker(entryId, field, currentValue){
    tpCurrent = { entryId, field };
    // Initialize picker from currentValue
    const parts = hhmmToParts(formatTimeValueForInput(currentValue || ''));
    tpHour = parts.hour12;
    tpMinute = parts.minute;
    tpAmpm = parts.ampm;
    tpBackdrop.classList.add('show');
    tpBackdrop.setAttribute('aria-hidden','false');
    syncTpSelection();
    // focus first option for accessibility
    setTimeout(()=> {
      const el = tpHoursEl.querySelector('.tp-option');
      if(el) el.focus();
    }, 100);
  }

  function closeTimePicker(){
    tpBackdrop.classList.remove('show');
    tpBackdrop.setAttribute('aria-hidden','true');
    tpCurrent = null;
  }

  function syncTpSelection(){
    // update classes
    Array.from(tpHoursEl.children).forEach(el => {
      if(parseInt(el.dataset.hour,10) === tpHour) el.classList.add('active'); else el.classList.remove('active');
    });
    Array.from(tpMinutesEl.children).forEach(el => {
      if(parseInt(el.dataset.minute,10) === tpMinute) el.classList.add('active'); else el.classList.remove('active');
    });
    tpAMBtn.classList.toggle('active', tpAmpm === 'AM');
    tpPMBtn.classList.toggle('active', tpAmpm === 'PM');

    tpPreviewTime.textContent = pad(tpHour) + ':' + pad(tpMinute) + ' ' + tpAmpm;
  }

  function confirmTimePicker(){
    if(!tpCurrent) return closeTimePicker();
    const hhmm = partsToHHMM(tpHour, tpMinute, tpAmpm); // "HH:MM" 24h
    updateEntry(tpCurrent.entryId, tpCurrent.field, hhmm);
    closeTimePicker();
  }

  /* ---------- Share ---------- */
  function buildShareMessage(){
    const lines = [];
    lines.push('Registro de suministros de ox√≠geno');
    lines.push('');
    lines.push('No. | Inicio | Fin | L/min | Min | Costo');
    lines.push('---------------------------------------------');
    entries.forEach((entry, i) => {
      const mins = minutesDiff(entry.startTime, entry.endTime);
      if(!mins || mins <= 0) return;
      const cost = calculateCostForEntry(entry);
      const inicio = entry.startTime ? formatToDisplay(formatTimeValueForInput(entry.startTime)) : '-';
      const fin = entry.endTime ? formatToDisplay(formatTimeValueForInput(entry.endTime)) : '-';
      const flow = entry.flowRate || '-';
      const costStr = cost > 0 ? cost.toFixed(2) : '-';
      lines.push(`${i+1} | ${inicio} | ${fin} | ${flow} | ${mins} | ${costStr}`);
    });
    lines.push('');
    lines.push(`Total a Pagar: $${calculateTotal().toFixed(2)}`);
    lines.push(`Factor aplicado: ${paymentFactor} (${insuranceType})`);
    return lines.join('\n');
  }

  async function shareViaWhatsApp(){
    const message = buildShareMessage();
    const waUrl = 'https://wa.me/?text=' + encodeURIComponent(message);
    try{
      if (navigator.share) {
        await navigator.share({text: message, title: 'Registro de ox√≠geno'});
        return;
      }
    }catch(e){}
    window.open(waUrl, '_blank');
    try{ await navigator.clipboard.writeText(message); alert('Mensaje copiado al portapapeles. Puedes pegarlo en WhatsApp si no abre autom√°ticamente.'); }catch(e){}
  }

  /* ---------- Inicializaci√≥n UI ---------- */
  document.getElementById('btnContri').addEventListener('click', ()=> {
    insuranceType = 'contributivo'; paymentFactor = 0.45;
    document.getElementById('btnContri').classList.add('btn--active'); document.getElementById('btnContri').classList.remove('btn--muted');
    document.getElementById('btnSubs').classList.remove('btn--active'); document.getElementById('btnSubs').classList.add('btn--muted');
    render();
  });
  document.getElementById('btnSubs').addEventListener('click', ()=> {
    insuranceType = 'subsidiado'; paymentFactor = 0.25;
    document.getElementById('btnSubs').classList.add('btn--active'); document.getElementById('btnSubs').classList.remove('btn--muted');
    document.getElementById('btnContri').classList.remove('btn--active'); document.getElementById('btnContri').classList.add('btn--muted');
    render();
  });
  document.getElementById('addRowBtn').addEventListener('click', addEntry);
  document.getElementById('shareBtn').addEventListener('click', shareViaWhatsApp);

  // build timepicker options and render initial UI
  buildTpOptions();
  render();

  // Close modal on ESC
  window.addEventListener('keydown', (ev)=> {
    if(ev.key === 'Escape' && tpBackdrop.classList.contains('show')) closeTimePicker();
  });

  // Accessibility: click outside to close (backdrop)
  tpBackdrop.addEventListener('click', (ev)=> {
    if(ev.target === tpBackdrop) closeTimePicker();
  });

  // expose for debug
  window.__oxygenCalc = { getEntries: ()=> entries, setEntries: (v)=> { entries = v; render(); } };

})();
</script>
</body>
</html>
